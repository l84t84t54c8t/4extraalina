import time
import logging

from pyrogram import Client, filters
from pyrogram.types import ChatPermissions, InlineKeyboardMarkup, InlineKeyboardButton
from pyrogram.errors.exceptions.bad_request_400 import UserNotParticipant, UsernameNotOccupied, ChatAdminRequired, PeerIdInvalid

from config import BANNED_USERS
from YukkiMusic.misc import SUDOERS
from YukkiMusic import app
from YukkiMusic.utils.sql import forceSubscribe_sql as sql

logging.basicConfig(level=logging.INFO)

static_data_filter = filters.create(lambda _, __, query: query.data == "onUnMuteRequest")
@app.on_callback_query(static_data_filter)
async def _onUnMuteRequest(app, cb):
  user_id = cb.from_user.id
  chat_id = cb.message.chat.id
  chat_db = sql.fs_settings(chat_id)
  if chat_db:
    channel = chat_db.channel
    chat_member = await app.get_chat_member(chat_id, user_id)
    if chat_member.restricted_by:
      if chat_member.restricted_by.id == (await app.get_me()).id:
          try:
            await app.get_chat_member(channel, user_id)
            await app.unban_chat_member(chat_id, user_id)
            if cb.message.reply_to_message.from_user.id == user_id:
              await cb.message.delete()
          except UserNotParticipant:
            await app.answer_callback_query(cb.id, text="âš ï¸ Join our 'Channel' and press the 'âœ… UnMute Me' button again.", show_alert=True)
      else:
        await app.answer_callback_query(cb.id, text="â— You are muted by admins for other reasons.", show_alert=True)
    else:
      if not (await app.get_chat_member(chat_id, (await app.get_me()).id)).status == 'administrator':
        await app.send_message(chat_id, f"â— **{cb.from_user.mention} is trying to UnMute himself but i can't unmute him because i am not an admin in this chat add me as admin again.**\n__#Leaving this chat...__")
        await app.leave_chat(chat_id)
      else:
        await app.answer_callback_query(cb.id, text="âš ï¸ Warning: Don't click the button if you can speak freely.", show_alert=True)



@app.on_message((filters.text | filters.media) & ~filters.private, group=1)
async def _check_member(app, message):
  chat_id = message.chat.id
  chat_db = sql.fs_settings(chat_id)
  if chat_db:
    user_id = message.from_user.id
    if not (await app.get_chat_member(chat_id, user_id)).status in ("administrator", "creator") and not user_id in SUDOERS:
      channel = chat_db.channel
      if channel.startswith("-"):
          channel_url = await app.export_chat_invite_link(int(channel))
      else:
          channel_url = f"https://t.me/{channel}"
      try:
        await app.get_chat_member(channel, user_id)
      except UserNotParticipant:
        try:
          sent_message = await message.reply_text(
              " {}\n\nYou haven't joined Our Channel.\nPlease join using below button and press the UnMute Me button to unmute yourself.".format(message.from_user.mention, channel, channel),
              disable_web_page_preview=True,
             reply_markup=InlineKeyboardMarkup(
            [
                [
                    InlineKeyboardButton("âš ï¸ Join Channel", url=channel_url)
                ],
                [
                    InlineKeyboardButton("âœ… UnMute Me", callback_data="onUnMuteRequest")
                ]
            ]
        )
          )
          await app.restrict_chat_member(chat_id, user_id, ChatPermissions(can_send_messages=False))
        except ChatAdminRequired:
          await sent_message.edit("â— **I am not an admin here.**\n__Make me admin with ban user permission and add me again.\n#Leaving this chat...__")
          await app.leave_chat(chat_id)
      except ChatAdminRequired:
        await app.send_message(chat_id, text=f"â— **I am not an admin in [channel]({channel_url})**\n__Make me admin in the channel and add me again.\n#Leaving this chat...__")
        await app.leave_chat(chat_id)


@app.on_message(filters.command(["forcesubscribe", "fsub"]) & ~filters.private)
async def config(app, message):
  user = await app.get_chat_member(message.chat.id, message.from_user.id)
  if user.status == "creator" or user.user.id in SUDOERS:
    chat_id = message.chat.id
    if len(message.command) > 1:
      input_str = message.command[1]
      input_str = input_str.replace("@", "")
      if input_str.lower() in ("off", "no", "disable"):
        sql.disapprove(chat_id)
        await message.reply_text("âŒ **Force Subscribe is Disabled Successfully.**")
      elif input_str.lower() in ('clear'):
        sent_message = await message.reply_text('**Unmuting all members who are muted by me...**')
        try:
          for chat_member in (await client.get_chat_members(message.chat.id, filter="restricted")):
            if chat_member.restricted_by.id == (await app.get_me()).id:
                await app.unban_chat_member(chat_id, chat_member.user.id)
                time.sleep(1)
          await sent_message.edit('âœ… **UnMuted all members who are muted by me.**')
        except ChatAdminRequired:
          await sent_message.edit('â— **I am not an admin in this chat.**\n__I can\'t unmute members because i am not an admin in this chat make me admin with ban user permission.__')
      else:
        try:
          await app.get_chat_member(input_str, "me")
          sql.add_channel(chat_id, input_str)
          if input_str.startswith("-"):
              channel_url = await app.export_chat_invite_link(int(input_str))
          else:
              channel_url = f"https://t.me/{input_str}"
          await message.reply_text(f"âœ… **Force Subscribe is Enabled**\n__Force Subscribe is enabled, all the group members have to subscribe this [channel]({channel_url}) in order to send messages in this group.__", disable_web_page_preview=True)
        except UserNotParticipant:
          await message.reply_text(f"â— **Not an Admin in the Channel**\n__I am not an admin in the [channel]({channel_url}). Add me as a admin in order to enable ForceSubscribe.__", disable_web_page_preview=True)
        except (UsernameNotOccupied, PeerIdInvalid):
          await message.reply_text(f"â— **Invalid Channel Username/ID.**")
        except Exception as err:
          await message.reply_text(f"â— **ERROR:** ```{err}```")
    else:
      if sql.fs_settings(chat_id):
        my_channel = sql.fs_settings(chat_id).channel
        if my_channel.startswith("-"):
            channel_url = await client.export_chat_invite_link(int(input_str))
        else:
            channel_url = f"https://t.me/{my_channel}"
        await message.reply_text(f"âœ… **Force Subscribe is enabled in this chat.**\n__For this [Channel]({channel_url})__", disable_web_page_preview=True)
      else:
        await message.reply_text("âŒ **Force Subscribe is disabled in this chat.**")
  else:
      await message.reply_text("â— **Group Creator Required**\n__You have to be the group creator to do that.__")


__HELP__ = """
Â» `/fsub` {channel username} - á´›á´ á´›á´œÊ€É´ á´É´ á´€É´á´… êœ±á´‡á´›á´œá´˜ á´›Êœá´‡ á´„Êœá´€É´É´á´‡ÊŸ.
  ğŸ’¡á´…á´ á´›ÊœÉªêœ± êœ°ÉªÊ€êœ±á´›...
Â» `/fsub` - á´›á´ É¢á´‡á´› á´›Êœá´‡ á´„á´œÊ€Ê€á´‡É´á´› êœ±á´‡á´›á´›ÉªÉ´É¢êœ±.
Â» `/fsub disable` - á´›á´ á´›á´œÊ€É´ á´êœ° êœ°á´Ê€á´„á´‡êœ±á´œÊ™êœ±á´„Ê€ÉªÊ™á´‡..
ğŸ’¡Éªêœ° Êá´á´œ á´…Éªêœ±á´€Ê™ÊŸá´‡ êœ°êœ±á´œÊ™, Êá´á´œ É´á´‡á´‡á´… á´›á´ êœ±á´‡á´› á´€É¢á´€ÉªÉ´ êœ°á´Ê€ á´¡á´Ê€á´‹ÉªÉ´É¢.. /fsub {channel username} 
Â» `/fsub clear` - á´›á´ á´œÉ´á´á´œá´›á´‡ á´€ÊŸÊŸ á´á´‡á´Ê™á´‡Ê€êœ± á´¡Êœá´ á´á´œá´›á´‡á´… Ê™Ê á´á´‡.
*êœ°á´‡á´…á´‡Ê€á´€á´›Éªá´É´*

á´‡á´ á´‡Ê€Êá´›ÊœÉªÉ´É¢ Éªêœ± êœ°á´œÉ´, á´œÉ´á´›ÉªÊŸ á´€ êœ±á´˜á´€á´á´á´‡Ê€ êœ±á´›á´€Ê€á´›êœ± á´‡É´á´›á´‡Ê€ÉªÉ´É¢ Êá´á´œÊ€ É¢Ê€á´á´œá´˜, á´€É´á´… Êá´á´œ Êœá´€á´ á´‡ á´›á´ Ê™ÊŸá´á´„á´‹ Éªá´›. á´›Êœá´‡É´ Êá´á´œ É´á´‡á´‡á´… á´›á´ êœ±á´›á´€Ê€á´› Ê™á´€É´É´ÉªÉ´É¢ á´á´Ê€á´‡, á´€É´á´… á´á´Ê€á´‡, á´€É´á´… Éªá´› Êœá´œÊ€á´›êœ±.
Ê™á´œá´› á´›Êœá´‡É´ Êá´á´œ Êœá´€á´ á´‡ á´á´€É´Ê É¢Ê€á´á´œá´˜êœ±, á´€É´á´… Êá´á´œ á´…á´É´'á´› á´¡á´€É´á´› á´›ÊœÉªêœ± êœ±á´˜á´€á´á´á´‡Ê€ á´›á´ Ê™á´‡ ÉªÉ´ á´É´á´‡ á´êœ° Êá´á´œÊ€ É¢Ê€á´á´œá´˜êœ± - Êœá´á´¡ á´„á´€É´ Êá´á´œ á´…á´‡á´€ÊŸ? á´…á´ Êá´á´œ Êœá´€á´ á´‡ á´›á´ á´á´€É´á´œá´€ÊŸÊŸÊ Ê™ÊŸá´á´„á´‹ Éªá´›, ÉªÉ´ á´€ÊŸÊŸ Êá´á´œÊ€ É¢Ê€á´á´œá´˜êœ±?\n
*É´á´ ÊŸá´É´É¢á´‡Ê€!* á´¡Éªá´›Êœ êœ°á´‡á´…á´‡Ê€á´€á´›Éªá´É´, Êá´á´œ á´„á´€É´ á´á´€á´‹á´‡ á´€ Ê™á´€É´ ÉªÉ´ á´É´á´‡ á´„Êœá´€á´› á´á´ á´‡Ê€ÊŸá´€á´˜ á´¡Éªá´›Êœ á´€ÊŸÊŸ á´á´›Êœá´‡Ê€ á´„Êœá´€á´›êœ±.\n
Êá´á´œ á´„á´€É´ á´‡á´ á´‡É´ á´…á´‡êœ±ÉªÉ¢É´á´€á´›á´‡ êœ°á´‡á´…á´‡Ê€á´€á´›Éªá´É´ á´€á´…á´ÉªÉ´êœ±, êœ±á´ Êá´á´œÊ€ á´›Ê€á´œêœ±á´›á´‡á´… á´€á´…á´ÉªÉ´ á´„á´€É´ Ê™á´€É´ á´€ÊŸÊŸ á´›Êœá´‡ êœ±á´˜á´€á´á´á´‡Ê€êœ± êœ°Ê€á´á´ á´„Êœá´€á´›êœ± Êá´á´œ á´¡á´€É´á´› á´›á´ á´˜Ê€á´á´›á´‡á´„á´›.\n

*á´„á´á´á´á´€É´á´…êœ±:*\n

êœ°á´‡á´…êœ± á´€Ê€á´‡ É´á´á´¡ á´…Éªá´ Éªá´…á´‡á´… ÉªÉ´á´›á´ 3 êœ±á´‡á´„á´›Éªá´É´êœ± êœ°á´Ê€ Êá´á´œÊ€ á´‡á´€êœ±á´‡.


"""
__MODULE__ = "F-SUB"
